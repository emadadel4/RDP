- name: Create Tunnel
  run: |
    $ngrokProcess = Start-Process -FilePath .\ngrok\ngrok.exe -ArgumentList "tcp 3389" -PassThru
    Start-Sleep -Seconds 5  # Allow time for ngrok to start

    # Fetch the public ngrok URL
    $ngrokUrl = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels | Select-Object -ExpandProperty tunnels | Select-Object -First 1 | Select-Object -ExpandProperty public_url

    # Retrieve secrets from environment
    $botToken = $Env:TELEGRAM_BOT_TOKEN
    $chatId = $Env:TELEGRAM_CHAT_ID
    $message = "Ngrok Tunnel is ready: $ngrokUrl"
    
    # Send the ngrok URL to Telegram
    Invoke-RestMethod -Uri "https://api.telegram.org/bot$botToken/sendMessage" `
      -Method Post `
      -ContentType "application/json" `
      -Body (@{chat_id=$chatId; text=$message} | ConvertTo-Json)

    # Optionally, wait for the process to exit
    $ngrokProcess.WaitForExit()
  env:
    TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
